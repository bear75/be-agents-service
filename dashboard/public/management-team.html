<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Management Team - Agent Service</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .management-container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
    }

    .nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px 30px;
      background: var(--glass-white);
      backdrop-filter: blur(var(--glass-blur)) saturate(180%);
      border: 2px solid var(--glass-border);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
    }

    .nav-header h1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }

    .nav-links {
      display: flex;
      gap: 10px;
    }

    .nav-link {
      padding: 10px 20px;
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 8px;
      color: var(--text-primary);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .nav-link.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .org-chart {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .exec-card {
      background: var(--glass-light);
      backdrop-filter: blur(15px);
      border: 2px solid var(--glass-border);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s;
    }

    .exec-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .exec-card.ceo {
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
    }

    .exec-card.cpo-cto {
      border-left: 4px solid #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .exec-card.cmo-cso {
      border-left: 4px solid #48bb78;
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
    }

    .exec-card.hr {
      border-left: 4px solid #f56565;
      background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
    }

    .exec-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .exec-emoji {
      font-size: 48px;
    }

    .exec-info h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .exec-info .role {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .exec-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .stat-item {
      padding: 10px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      text-transform: uppercase;
    }

    .action-panel {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 8px;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 40px 0 20px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    .task-card {
      background: white;
      border: 2px solid rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      padding: 15px;
      transition: all 0.2s;
    }

    .task-card:hover {
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: var(--shadow-md);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .badge.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .badge.in-progress { background: rgba(102, 126, 234, 0.2); color: #667eea; }
    .badge.completed { background: rgba(72, 187, 120, 0.2); color: #48bb78; }
    .badge.blocked { background: rgba(245, 101, 101, 0.2); color: #f56565; }

    .upload-zone {
      border: 2px dashed rgba(102, 126, 234, 0.3);
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 15px;
    }

    .upload-zone:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .agent-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .agent-card {
      background: white;
      border: 2px solid rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      transition: all 0.2s;
    }

    .agent-card:hover {
      border-color: rgba(102, 126, 234, 0.3);
      box-shadow: var(--shadow-md);
    }

    .agent-emoji {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .agent-name {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .agent-role {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .agent-metrics {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .metric {
      text-align: center;
    }

    .metric-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .metric-label {
      font-size: 10px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="management-container">
    <!-- Navigation Header -->
    <div class="nav-header">
      <h1 style="margin: 0;">üëî Management Team</h1>
      <div class="nav-links">
        <a href="/" class="nav-link">Dashboard</a>
        <a href="/management-team.html" class="nav-link active">Management (4)</a>
        <a href="/engineering.html" class="nav-link">Engineering (10)</a>
        <a href="/sales-marketing.html" class="nav-link">Sales & Marketing (10)</a>
        <a href="/rl-dashboard.html" class="nav-link">RL</a>
        <a href="/kanban.html" class="nav-link">üìã Task Board</a>
        <a href="/commands.html" class="nav-link">Docs</a>
        <a href="/settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      </div>
    </div>

    <!-- Executive Team Cards -->
    <div class="org-chart">
      <!-- CEO Card -->
      <div class="exec-card ceo">
        <div class="exec-header">
          <div class="exec-emoji">üë®‚Äçüíº</div>
          <div class="exec-info">
            <h3>CEO (You)</h3>
            <div class="role">Chief Executive Officer</div>
          </div>
        </div>
        <div class="exec-stats">
          <div class="stat-item">
            <div class="stat-value" id="ceo-tasks-assigned">0</div>
            <div class="stat-label">Tasks Assigned</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="ceo-strategies-active">0</div>
            <div class="stat-label">Active Strategies</div>
          </div>
        </div>
        <div class="action-panel">
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="showTaskUploadModal()">üì§ Upload Task</button>
            <button class="btn btn-warning" onclick="showStrategyModal()">üéØ Set Strategy</button>
            <button class="btn btn-success" onclick="showPromptModal()">üí¨ Issue Prompt</button>
          </div>
        </div>
      </div>

      <!-- CPO & CTO Card -->
      <div class="exec-card cpo-cto">
        <div class="exec-header">
          <div class="exec-emoji">‚öôÔ∏è</div>
          <div class="exec-info">
            <h3>CPO & CTO</h3>
            <div class="role">Product & Technology Lead</div>
          </div>
        </div>
        <div class="exec-stats">
          <div class="stat-item">
            <div class="stat-value" id="eng-team-size">6</div>
            <div class="stat-label">Team Size</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="eng-success-rate">0%</div>
            <div class="stat-label">Success Rate</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="eng-active-tasks">0</div>
            <div class="stat-label">Active Tasks</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="eng-completed">0</div>
            <div class="stat-label">Completed</div>
          </div>
        </div>
        <div class="action-panel">
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="location.href='/engineering.html'">üîß View Team</button>
            <button class="btn btn-success" onclick="assignTask('engineering')">üìã Assign Task</button>
          </div>
        </div>
      </div>

      <!-- CMO & CSO Card -->
      <div class="exec-card cmo-cso">
        <div class="exec-header">
          <div class="exec-emoji">üìä</div>
          <div class="exec-info">
            <h3>CMO & CSO</h3>
            <div class="role">Marketing & Sales Lead</div>
          </div>
        </div>
        <div class="exec-stats">
          <div class="stat-item">
            <div class="stat-value" id="mkt-team-size">10</div>
            <div class="stat-label">Team Size</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="mkt-success-rate">0%</div>
            <div class="stat-label">Success Rate</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="mkt-campaigns">0</div>
            <div class="stat-label">Campaigns</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="mkt-leads">0</div>
            <div class="stat-label">Leads</div>
          </div>
        </div>
        <div class="action-panel">
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="location.href='/sales-marketing.html'">üìà View Team</button>
            <button class="btn btn-success" onclick="assignTask('marketing')">üìã Assign Task</button>
          </div>
        </div>
      </div>

      <!-- HR (Agent Manager) Card -->
      <div class="exec-card hr">
        <div class="exec-header">
          <div class="exec-emoji">ü§ñ</div>
          <div class="exec-info">
            <h3>HR - Agent Lead</h3>
            <div class="role">Agent Lifecycle Management</div>
          </div>
        </div>
        <div class="exec-stats">
          <div class="stat-item">
            <div class="stat-value" id="total-agents">0</div>
            <div class="stat-label">Total Agents</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="active-agents">0</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="other-agents-count">0</div>
            <div class="stat-label">Management / Other</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="high-performers">0</div>
            <div class="stat-label">High Performers</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="needs-improvement">0</div>
            <div class="stat-label">Needs Review</div>
          </div>
        </div>
        <div class="action-panel">
          <div class="action-buttons">
            <button class="btn btn-success" onclick="showHireAgentModal()">‚ûï Hire Agent</button>
            <button class="btn btn-danger" onclick="showFireAgentModal()">‚ùå Fire Agent</button>
            <button class="btn btn-primary" onclick="showAgentEvaluationsModal()">üìä Evaluations</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CEO Tasks Section -->
    <div class="section-header">
      <h2 class="section-title">üìã CEO Tasks & Directives</h2>
      <button class="btn btn-primary" onclick="showTaskUploadModal()">+ New Task</button>
    </div>
    <div class="tasks-grid" id="ceo-tasks">
      <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
        <p>No tasks assigned yet. Upload a task file or issue a prompt to get started.</p>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="section-header">
      <h2 class="section-title">üèÜ Leaderboard</h2>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="loadLeaderboard('xp')" style="width: auto; padding: 8px 16px;">XP</button>
        <button class="btn btn-secondary" onclick="loadLeaderboard('tasks')" style="width: auto; padding: 8px 16px;">Tasks</button>
        <button class="btn btn-secondary" onclick="loadLeaderboard('success')" style="width: auto; padding: 8px 16px;">Success Rate</button>
      </div>
    </div>
    <div class="leaderboard-grid" id="leaderboard" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <div style="text-align: center; padding: 20px;">Loading leaderboard...</div>
    </div>

    <!-- All Agents Overview -->
    <div class="section-header">
      <h2 class="section-title">üë• All Agents</h2>
      <button class="btn btn-primary" onclick="refreshAgents()">üîÑ Refresh</button>
    </div>
    <div class="agent-list" id="all-agents">
      <div style="text-align: center; padding: 20px;">Loading agents...</div>
    </div>
  </div>

  <script>
    // Initialize
    async function init() {
      await Promise.all([
        loadCEOTasks(),
        loadLeaderboard('xp'),
        loadAllAgents(),
        loadManagementStats()
      ]);

      // Auto-refresh every 10 seconds
      setInterval(async () => {
        await Promise.all([
          loadLeaderboard('xp'),
          loadAllAgents(),
          loadManagementStats()
        ]);
      }, 10000);
    }

    // Load CEO tasks
    async function loadCEOTasks() {
      try {
        // TODO: Create CEO tasks endpoint
        const container = document.getElementById('ceo-tasks');
        container.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
            <p>No tasks assigned yet. Upload a task file or issue a prompt to get started.</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading CEO tasks:', error);
      }
    }

    // Load leaderboard
    async function loadLeaderboard(metric = 'xp') {
      try {
        const response = await fetch(`/api/gamification/leaderboard?metric=${metric}&limit=10`);
        const leaderboard = await response.json();

        const container = document.getElementById('leaderboard');

        if (!leaderboard || leaderboard.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No leaderboard data yet</div>';
          return;
        }

        const metricLabel = metric === 'xp' ? 'XP' : metric === 'tasks' ? 'Tasks' : 'Success Rate';
        const metricKey = metric === 'xp' ? 'total_xp' : metric === 'tasks' ? 'tasks_completed' : 'success_rate_pct';

        container.innerHTML = leaderboard.map((agent, index) => {
          const rank = index + 1;
          const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
          const metricValue = metric === 'success' ? `${agent[metricKey]}%` : agent[metricKey];

          return `
            <div style="background: var(--glass-light); border: 2px solid var(--glass-border); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 24px; font-weight: 800; width: 40px;">${rankEmoji}</div>
                <div style="font-size: 28px;">${agent.agent_emoji}</div>
                <div>
                  <div style="font-weight: 700; color: var(--text-primary);">${agent.agent_name}</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">${agent.team_name}</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 24px; font-weight: 800; color: #667eea;">${metricValue}</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${metricLabel}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // Load all agents
    async function loadAllAgents() {
      try {
        const response = await fetch('/api/rl/agent-performance');
        const agents = await response.json();

        const container = document.getElementById('all-agents');

        if (!agents || agents.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 20px;">No agents found</div>';
          return;
        }

        const agentEmojis = {
          'orchestrator': 'üéØ', 'backend': '‚öôÔ∏è', 'frontend': 'üé®',
          'infrastructure': 'üîß', 'verification': '‚úÖ', 'senior reviewer': 'üë®‚Äçüíº',
          'jarvis': 'ü§ñ', 'shuri': 'üíé', 'fury': 'üëÅÔ∏è', 'vision': 'üíé',
          'loki': '‚úçÔ∏è', 'wanda': 'üîÆ', 'quill': 'üéµ', 'pepper': 'üìß',
          'friday': 'üìä', 'wong': 'üìö'
        };

        container.innerHTML = agents.map(agent => {
          const emoji = agentEmojis[agent.name.toLowerCase()] || 'ü§ñ';
          const successRate = parseInt(agent.successRate) || 0;
          const statusColor = successRate >= 90 ? '#48bb78' : successRate >= 70 ? '#667eea' : '#f59e0b';

          return `
            <div class="agent-card">
              <div class="agent-emoji">${emoji}</div>
              <div class="agent-name">${agent.name}</div>
              <div class="agent-role">${agent.team}</div>
              <div class="agent-metrics">
                <div class="metric">
                  <div class="metric-value" style="color: ${statusColor};">${agent.successRate}</div>
                  <div class="metric-label">Success</div>
                </div>
                <div class="metric">
                  <div class="metric-value">${agent.tasksCompleted}</div>
                  <div class="metric-label">Tasks</div>
                </div>
              </div>
              <button class="btn btn-primary" style="width: 100%; margin-top: 10px; font-size: 11px;" onclick="viewAgentDetails('${agent.name}')">
                View Details
              </button>
            </div>
          `;
        }).join('');

        // Update totals
        document.getElementById('total-agents').textContent = agents.length;
        document.getElementById('active-agents').textContent = agents.filter(a => parseInt(a.successRate) > 0).length;
        document.getElementById('high-performers').textContent = agents.filter(a => parseInt(a.successRate) >= 90).length;
        document.getElementById('needs-improvement').textContent = agents.filter(a => parseInt(a.successRate) < 50 && a.tasksCompleted > 0).length;
      } catch (error) {
        console.error('Error loading agents:', error);
      }
    }

    // Load management stats
    async function loadManagementStats() {
      try {
        const response = await fetch('/api/rl/agent-performance');
        const agents = await response.json();

        const engAgents = agents.filter(a => a.team === 'Engineering');
        const mktAgents = agents.filter(a => a.team === 'Marketing');
        const otherAgents = agents.filter(a => a.team !== 'Engineering' && a.team !== 'Marketing');

        const engCompleted = engAgents.reduce((sum, a) => sum + (a.tasksCompleted || 0), 0);
        const mktCompleted = mktAgents.reduce((sum, a) => sum + (a.tasksCompleted || 0), 0);

        // Only include agents with at least 1 task (completed or failed) in success rate
        const engAgentsWithTasks = engAgents.filter(a => (a.tasksCompleted || 0) + (a.tasksFailed || 0) > 0);
        const mktAgentsWithTasks = mktAgents.filter(a => (a.tasksCompleted || 0) + (a.tasksFailed || 0) > 0);

        const engSuccess = engAgentsWithTasks.length > 0
          ? Math.round(engAgentsWithTasks.reduce((sum, a) => sum + parseInt(a.successRate, 10) || 0, 0) / engAgentsWithTasks.length)
          : 0;
        const mktSuccess = mktAgentsWithTasks.length > 0
          ? Math.round(mktAgentsWithTasks.reduce((sum, a) => sum + parseInt(a.successRate, 10) || 0, 0) / mktAgentsWithTasks.length)
          : 0;

        // Update engineering stats (including team size)
        const engTeamSizeEl = document.getElementById('eng-team-size');
        const engSuccessEl = document.getElementById('eng-success-rate');
        const engCompletedEl = document.getElementById('eng-completed');
        if (engTeamSizeEl) engTeamSizeEl.textContent = engAgents.length;
        if (engSuccessEl) engSuccessEl.textContent = engSuccess + '%';
        if (engCompletedEl) engCompletedEl.textContent = engCompleted;

        // Update marketing stats (including team size)
        const mktTeamSizeEl = document.getElementById('mkt-team-size');
        const mktSuccessEl = document.getElementById('mkt-success-rate');
        const mktCompletedEl = document.getElementById('mkt-completed');
        if (mktTeamSizeEl) mktTeamSizeEl.textContent = mktAgents.length;
        if (mktSuccessEl) mktSuccessEl.textContent = mktSuccess + '%';
        if (mktCompletedEl) mktCompletedEl.textContent = mktCompleted;

        // Update HR card: missing/other agents (Management team, not in Engineering or Marketing)
        const otherAgentsEl = document.getElementById('other-agents-count');
        if (otherAgentsEl) otherAgentsEl.textContent = otherAgents.length;
      } catch (error) {
        console.error('Error loading management stats:', error);
      }
    }

    // Actions
    function showTaskUploadModal() {
      alert('üì§ Upload Task\n\nFeature coming soon:\n- Upload priority files\n- Upload PRD documents\n- Attach strategy documents');
    }

    function showStrategyModal() {
      alert('üéØ Set Strategy\n\nFeature coming soon:\n- Define quarterly goals\n- Set team priorities\n- Allocate resources');
    }

    function showPromptModal() {
      const prompt = window.prompt('üí¨ Issue CEO Directive:\n\nEnter your command or task for the management team:');
      if (prompt) {
        alert('CEO directive received:\n\n"' + prompt + '"\n\nThis will be routed to the appropriate team.');
      }
    }

    function assignTask(team) {
      alert(`üìã Assign Task to ${team}\n\nFeature coming soon:\n- Create new task\n- Assign to team\n- Set priority and deadline`);
    }

    async function showHireAgentModal() {
      const team = prompt('Select Team:\n\n1. team-engineering\n2. team-marketing\n\nEnter team ID:');
      if (!team) return;

      const name = prompt('Agent Name:');
      if (!name) return;

      const role = prompt('Agent Role/Specialty:');
      if (!role) return;

      const llmPreference = prompt('LLM Preference (sonnet/opus/haiku):', 'sonnet');

      try {
        const response = await fetch('/api/agents/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamId: team,
            name,
            role,
            llmPreference: llmPreference || 'sonnet'
          })
        });

        const result = await response.json();

        if (response.ok) {
          alert(`‚úÖ ${result.message}\n\nAgent ID: ${result.agent.id}\n\nRefreshing agents list...`);
          await loadAllAgents();
          await loadManagementStats();
        } else {
          alert(`‚ùå Error: ${result.error}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    async function showFireAgentModal() {
      try {
        const response = await fetch('/api/rl/agent-performance');
        const agents = await response.json();

        if (!agents || agents.length === 0) {
          alert('No agents to fire');
          return;
        }

        const agentList = agents.map((a, i) =>
          `${i + 1}. ${a.name} (${a.team}) - Success: ${a.successRate}, Tasks: ${a.tasksCompleted}`
        ).join('\n');

        const selection = prompt(`Select agent to fire:\n\n${agentList}\n\nEnter number (1-${agents.length}):`);
        if (!selection) return;

        const index = parseInt(selection) - 1;
        if (index < 0 || index >= agents.length) {
          alert('Invalid selection');
          return;
        }

        const selectedAgent = agents[index];

        // Get agent ID from database
        const allAgentsResponse = await fetch('/api/agents');
        const allAgents = await allAgentsResponse.json();
        const agentToFire = allAgents.find(a => a.name === selectedAgent.name);

        if (!agentToFire) {
          alert('Agent not found in database');
          return;
        }

        const confirmed = confirm(`‚ö†Ô∏è Fire ${agentToFire.name}?\n\nThis will deactivate the agent.\n\nPerformance:\n- Success Rate: ${selectedAgent.successRate}\n- Tasks Completed: ${selectedAgent.tasksCompleted}\n- Tasks Failed: ${selectedAgent.tasksFailed}\n\nProceed?`);

        if (!confirmed) return;

        const fireResponse = await fetch(`/api/agents/${agentToFire.id}/fire`, {
          method: 'POST'
        });

        const result = await fireResponse.json();

        if (fireResponse.ok) {
          alert(`‚úÖ ${agentToFire.name} has been fired (deactivated).\n\nThe agent can be rehired later if needed.`);
          await loadAllAgents();
          await loadManagementStats();
        } else {
          alert(`‚ùå Error: ${result.error}`);
        }
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    async function showAgentEvaluationsModal() {
      try {
        const response = await fetch('/api/rl/agent-performance');
        const agents = await response.json();

        if (!agents || agents.length === 0) {
          alert('No agents found');
          return;
        }

        const agentList = agents.map((a, i) => {
          const successRate = parseInt(a.successRate) || 0;
          let recommendation = '‚úÖ Continue';
          if (successRate >= 90 && a.tasksCompleted >= 5) {
            recommendation = '‚≠ê Double Down (High Performer)';
          } else if (successRate < 50 && a.tasksCompleted >= 5) {
            recommendation = '‚ö†Ô∏è Investigate (Struggling)';
          } else if (successRate < 30 && a.tasksCompleted >= 10) {
            recommendation = 'üî¥ Consider Firing';
          } else if (a.tasksCompleted === 0) {
            recommendation = 'üëÄ Monitor (No tasks yet)';
          }

          return `${i + 1}. ${a.name} (${a.team})\n   Success: ${a.successRate} | Tasks: ${a.tasksCompleted}\n   ${recommendation}`;
        }).join('\n\n');

        alert(`üìä Agent RL Evaluations\n\n${agentList}`);
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    async function viewAgentDetails(agentName) {
      try {
        // Get all agents to find the ID
        const allAgentsResponse = await fetch('/api/agents');
        const allAgents = await allAgentsResponse.json();
        const agent = allAgents.find(a => a.name === agentName);

        if (!agent) {
          alert(`Agent ${agentName} not found in database`);
          return;
        }

        // Get full evaluation
        const evalResponse = await fetch(`/api/agents/${agent.id}/evaluation`);
        const evaluation = await evalResponse.json();

        if (!evaluation || !evaluation.agent) {
          alert(`Could not load evaluation for ${agentName}`);
          return;
        }

        const { agent: agentData, performance, taskStats, recentTasks, gamification, lessonsLearned, evaluation: rlEval } = evaluation;

        // Build task stats summary
        const taskStatsHtml = taskStats && taskStats.length > 0
          ? taskStats.map(t => `<div style="display: inline-block; margin-right: 20px;"><strong>${t.status}:</strong> ${t.count}</div>`).join('')
          : '<div>No tasks yet</div>';

        // Build recent tasks list
        const recentTasksHtml = recentTasks && recentTasks.length > 0
          ? recentTasks.slice(0, 10).map(task => {
              const statusIcon = task.status === 'completed' ? '‚úÖ' : task.status === 'failed' ? '‚ùå' : task.status === 'in_progress' ? 'üîÑ' : '‚è∏Ô∏è';
              const duration = task.duration_seconds ? `${Math.round(task.duration_seconds / 60)}m` : '-';
              return `
                <div style="padding: 8px; background: var(--glass-light); border-radius: 8px; margin-bottom: 8px;">
                  ${statusIcon} <strong>${task.description?.substring(0, 60) || 'Task'}${task.description?.length > 60 ? '...' : ''}</strong>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                    Duration: ${duration} | LLM: ${task.llm_used || 'N/A'} | ${new Date(task.started_at).toLocaleDateString()}
                  </div>
                </div>
              `;
            }).join('')
          : '<div style="color: var(--text-muted); font-style: italic;">No tasks yet</div>';

        // Build gamification section
        const gamificationHtml = gamification
          ? `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px;">
              <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                <div style="font-size: 32px;">${gamification.level_emoji}</div>
                <div style="font-size: 20px; font-weight: 800;">Level ${gamification.level}</div>
                <div style="font-size: 12px; opacity: 0.9;">${gamification.title}</div>
              </div>
              <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white;">
                <div style="font-size: 28px; font-weight: 800;">${gamification.total_xp}</div>
                <div style="font-size: 12px; opacity: 0.9;">Total XP</div>
                <div style="font-size: 10px; opacity: 0.7;">${gamification.xp_to_next_level} to next</div>
              </div>
              <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; color: white;">
                <div style="font-size: 28px; font-weight: 800;">${gamification.achievements_unlocked}</div>
                <div style="font-size: 12px; opacity: 0.9;">Achievements</div>
              </div>
              <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 12px; color: white;">
                <div style="font-size: 28px;">üî•</div>
                <div style="font-size: 20px; font-weight: 800;">${gamification.current_streak}</div>
                <div style="font-size: 12px; opacity: 0.9;">Day Streak</div>
              </div>
            </div>
          `
          : '<div style="color: var(--text-muted); font-style: italic;">Gamification data not available</div>';

        // Build lessons learned section
        const lessonsHtml = lessonsLearned && lessonsLearned.length > 0
          ? lessonsLearned.slice(0, 5).map(lesson => `
              <div style="padding: 10px; background: var(--glass-light); border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-weight: 700; color: var(--text-primary);">${lesson.title}</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${lesson.description}</div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                  Category: ${lesson.category || 'General'} | Encountered ${lesson.times_encountered}x
                  ${lesson.is_automated ? ' | ‚úÖ Automated' : ''}
                </div>
              </div>
            `).join('')
          : '<div style="color: var(--text-muted); font-style: italic;">No lessons learned yet</div>';

        // Create modal HTML
        const modalHtml = `
          <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
            <div style="background: var(--bg-primary); border-radius: 20px; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">

              <!-- Header -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                  <div style="font-size: 48px;">${agentData.emoji || 'ü§ñ'}</div>
                  <div>
                    <h2 style="margin: 0; color: var(--text-primary); font-size: 28px;">${agentData.name}</h2>
                    <div style="color: var(--text-secondary); font-size: 14px;">${agentData.team_name || agentData.team_id} | ${agentData.role}</div>
                  </div>
                </div>
                <button onclick="this.closest('[style*=\\'fixed\\']').remove()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: var(--text-muted);">&times;</button>
              </div>

              <!-- Agent Soul (Description/Role) -->
              <div style="background: var(--glass-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 18px;">üéØ Agent Soul</h3>
                <div style="color: var(--text-secondary);">${agentData.role}</div>
                <div style="margin-top: 10px; font-size: 13px; color: var(--text-muted);">
                  LLM Preference: <strong>${agentData.llm_preference}</strong> |
                  Status: ${agentData.is_active ? '<span style="color: #48bb78;">‚úÖ Active</span>' : '<span style="color: #f56565;">‚ùå Inactive</span>'}
                </div>
              </div>

              <!-- Gamification -->
              <div style="background: var(--glass-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 18px;">üéÆ Gamification</h3>
                ${gamificationHtml}
              </div>

              <!-- Performance & RL Evaluation -->
              <div style="background: var(--glass-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 18px;">üìä Performance & RL Evaluation</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                  <div style="text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #667eea;">${rlEval.successRate}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Success Rate</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #667eea;">${performance?.total_tasks_completed || 0}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Completed</div>
                  </div>
                  <div style="text-align: center;">
                    <div style="font-size: 28px; font-weight: 800; color: #f56565;">${performance?.total_tasks_failed || 0}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Failed</div>
                  </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: var(--glass-light); border-left: 4px solid #667eea; border-radius: 8px;">
                  <div style="font-weight: 700; color: var(--text-primary);">Recommendation: ${rlEval.recommendation.toUpperCase()}</div>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-top: 5px;">${rlEval.reason}</div>
                </div>
              </div>

              <!-- Task Stats -->
              <div style="background: var(--glass-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 18px;">üìã Task Statistics</h3>
                <div style="margin-top: 10px;">
                  ${taskStatsHtml}
                </div>
              </div>

              <!-- Recent Tasks -->
              <div style="background: var(--glass-light); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px;">üìù Recent Tasks</h3>
                ${recentTasksHtml}
              </div>

              <!-- Lessons Learned -->
              <div style="background: var(--glass-light); border-radius: 12px; padding: 20px;">
                <h3 style="margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px;">üí° Lessons Learned</h3>
                ${lessonsHtml}
              </div>

            </div>
          </div>
        `;

        // Insert modal into page
        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (error) {
        console.error('Error loading agent details:', error);
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    function refreshAgents() {
      loadAllAgents();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
